{% extends "users/base.html" %} {% load static %} {% block body %}

<div class="mt-10 flex justify-center">
  <h2 class="text-3xl font-normal text-gray-600">Feed</h2>
</div>

<div class="grid mx-auto mt-8 w-full max-w-2xl">
  {% for post in posts %}
  <div class="rounded overflow-hidden bg-white shadow-lg mb-10">
    <!-- User info -->
    <div class="flex items-center px-5 py-4">
      <img
        class="h-10 w-10 rounded-full"
        src="{{ post.user.profile.photo.url }}"
        alt=""
      />
      <span class="ml-3 font-semibold text-gray-700">
        {{ post.user.username }}
      </span>
    </div>

    <!-- Image -->
    <a href="{% url 'posts:post_detail' post.slug %}"
      ><img src="{{ post.image.url }}"
    /></a>

    <!-- Actions -->
    <div class="px-5 py-3 flex items-center gap-4">
      <!-- Like -->
      <form
        method="post"
        action="{% url 'posts:toggle_like' post.id %}"
        class="m-0"
      >
        {% csrf_token %}
        <button type="submit">
          {% if post.id in liked_post_ids %}
          <img
            src="{% static 'users/images/Red Like.png' %}"
            alt="Unlike"
            class="w-7 h-7"
          />
          {% else %}
          <img
            src="{% static 'users/images/White Like.png' %}"
            alt="Like"
            class="w-6 h-6"
          />
          {% endif %}
        </button>
      </form>
      <!-- Comment -->
      <button type="button" onclick="toggleCommentBox({{ post.id }})">
        <img
          src="{% static 'users/images/comment.png' %}"
          class="w-6 h-6"
          alt="Comment"
        />
      </button>
    </div>

    <!-- Like count -->
    <div class="px-5 text-sm text-gray-600">
      {% if post.like_count > 0 %} {{ post.like_count }}
      like{{post.likes.count|pluralize }} {% endif %}
    </div>

    <!-- Caption -->
    <div class="px-5 py-4">
      <h3 class="font-bold text-lg">{{ post.title }}</h3>
      <p class="text-gray-700">{{ post.caption }}</p>
    </div>

    <!-- Comments -->
    <div class="px-5 pb-3 space-y-1">
      {% for comment in post.comments.all %}
      <p class="text-sm">
        <span class="font-semibold"> {{ comment.posted_by.username }} </span> 
        {{comment.body }}
      </p>
      {% empty %}
      <p class="text-sm text-gray-400">No comments yet</p>
      {% endfor %}
    </div>

    <!-- Add comment -->

    <div id="comment-box-{{ post.id }}" class="px-5 py-4 border-t hidden">
      <form
        method="post"
        action="{% url 'posts:add_comment' post.id %}"
        class="flex items-center gap-2"
      >
        {% csrf_token %} {{ comment_form_class.body }}
        <button type="submit" class="bg-green-500 text-white px-4 py-1 rounded">
          Add
        </button>
      </form>
    </div>
  </div>
  {% endfor %}
  <div class="flex justify-center gap-4 my-8">
    {% if page_obj.has_previous %}
    <a
      href="?page={{ page_obj.previous_page_number }}"
      class="px-4 py-2 bg-gray-200 rounded"
    >
      Previous
    </a>
    {% endif %}

    <span class="px-4 py-2 text-gray-600">
      Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
    <a
      href="?page={{ page_obj.next_page_number }}"
      class="px-4 py-2 bg-gray-200 rounded"
    >
      Next
    </a>
    {% endif %}
  </div>
</div>

<script>
  function toggleCommentBox(postId) {
    const box = document.getElementById(`comment-box-${postId}`);
    if (box) {
      box.classList.toggle("hidden");
    }
  }
</script>

{% endblock body %}
