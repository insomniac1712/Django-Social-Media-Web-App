{% load static %}

<div id="comments-{{ post.id }}" class="px-7 pb-4">
  {% for comment in post.comments.all %}
    <div class="mb-2 text-sm text-gray-700">
      <div id="comment-view-{{ comment.id }}" class="flex items-center justify-between gap-3">
        <p class="flex-1 leading-5">
          <b class="text-gray-900">{{ comment.posted_by.username }}</b> {{ comment.body }}
        </p>

        {% if show_comment_actions and request.user == comment.posted_by %}
          <div class="flex shrink-0 items-center gap-1 leading-none">
            <button
              type="button"
              onclick="document.getElementById('comment-view-{{ comment.id }}').classList.add('hidden'); document.getElementById('comment-edit-{{ comment.id }}').classList.remove('hidden');"
              class="m-0 inline-flex h-7 w-7 items-center justify-center rounded border-0 bg-green-500 p-0 align-middle leading-none hover:bg-green-600"
              aria-label="Edit comment"
            >
              <img src="{% static 'users/images/edit.png' %}" alt="Edit" class="block h-4 w-4 object-contain" />
            </button>

            <form
              hx-post="{% url 'posts:comment_delete' comment.id %}"
              hx-target="#comments-{{ post.id }}"
              hx-swap="outerHTML"
              class="m-0 inline p-0 align-middle leading-none"
            >
              {% csrf_token %}
              <input
                type="hidden"
                name="show_comment_actions"
                value="{% if show_comment_actions %}1{% else %}0{% endif %}"
              />
              <button
                type="submit"
                class="m-0 inline-flex h-7 w-7 items-center justify-center rounded border-0 bg-red-500 p-0 align-middle leading-none hover:bg-red-600"
                aria-label="Delete comment"
              >
                <img src="{% static 'users/images/delete.png' %}" alt="Delete" class="block h-4 w-4 object-contain" />
              </button>
            </form>
          </div>
        {% endif %}
      </div>

      {% if show_comment_actions and request.user == comment.posted_by %}
        <form
          id="comment-edit-{{ comment.id }}"
          hx-post="{% url 'posts:comment_edit' comment.id %}"
          hx-target="#comments-{{ post.id }}"
          hx-swap="outerHTML"
          class="mt-2 hidden"
        >
          {% csrf_token %}
          <input
            type="hidden"
            name="show_comment_actions"
            value="{% if show_comment_actions %}1{% else %}0{% endif %}"
          />
          <div class="flex items-center gap-2">
            <input
              type="text"
              name="body"
              value="{{ comment.body }}"
              class="w-full rounded border border-gray-300 px-2 py-1 text-sm focus:border-gray-400 focus:outline-none"
            />
            <button
              type="submit"
              class="rounded bg-gray-800 px-3 py-1 text-sm text-white hover:bg-gray-700"
            >
              Save
            </button>
            <button
              type="button"
              onclick="document.getElementById('comment-edit-{{ comment.id }}').classList.add('hidden'); document.getElementById('comment-view-{{ comment.id }}').classList.remove('hidden');"
              class="rounded border border-gray-300 px-3 py-1 text-sm text-gray-700 hover:bg-gray-50"
            >
              Cancel
            </button>
          </div>
        </form>
      {% endif %}
    </div>
  {% endfor %}

  <div id="comment-box-{{ post.id }}" class="mt-3 hidden border-t border-gray-100 pt-3">
    <form
      hx-post="{% url 'posts:add_comment' post.id %}"
      hx-target="#comments-{{ post.id }}"
      hx-swap="outerHTML"
    >
      {% csrf_token %}
      <input
        type="hidden"
        name="show_comment_actions"
        value="{% if show_comment_actions %}1{% else %}0{% endif %}"
      />
      <div class="flex items-center gap-2">
        {{ comment_form_class.body }}
        <button
          type="submit"
          class="rounded bg-gray-800 px-3 py-1 text-sm text-white hover:bg-gray-700"
        >
          Add
        </button>
      </div>
    </form>
  </div>
</div>
